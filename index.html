<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PopFruit Ultimate - Movie Final V3</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --primary: #ffcf33; --bg: #000; --orange: #e67e22; --danger: #ff4757; --success: #2ed573; --dark-card: #1e1e1e; }
        * { font-family: 'Kanit', sans-serif; box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: white; height: 100vh; overflow: hidden; touch-action: none; display: flex; flex-direction: column; align-items: center; user-select: none; }
        
        #app { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; position: relative; }
        
        /* ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏•‡πà‡∏≠‡∏á‡∏´‡∏ô (‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô) */
        #admin-trigger { position: absolute; top: 0; left: 0; width: 60px; height: 60px; z-index: 1000; background: transparent; cursor: default; }

        .score-box { text-align: center; z-index: 20; position: absolute; top: 15px; width: 100%; pointer-events: none; }
        #score { font-size: 5rem; font-weight: 900; margin: 0; line-height: 1; text-shadow: 2px 2px 4px #000; }
        #user-label { font-size: 1.4rem; color: var(--primary); font-weight: 600; }
        
        .click-zone { flex-grow: 1; width: 100%; display: flex; align-items: flex-end; justify-content: center; cursor: pointer; overflow: hidden; }
        .cat-img { height: 90vh; width: auto; transition: transform 0.1s; transform-origin: bottom center; }
        .cat-img.popped { transform: scale(1.05); filter: brightness(1.1); }

        /* Modals UI */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(8px); }
        .modal-content { background: #121212; width: 95%; max-width: 500px; padding: 25px; border-radius: 25px; border: 1px solid #333; max-height: 90vh; overflow-y: auto; }
        
        input { width: 100%; padding: 12px; margin: 8px 0; background: #252525; border: 1px solid #444; color: white; border-radius: 10px; font-size: 1.1rem; text-align: center; }
        .btn-action { background: var(--orange); color: white; border: none; padding: 14px; width: 100%; border-radius: 10px; font-size: 1.2rem; font-weight: 900; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-action:active { transform: scale(0.95); }

        /* Admin UI */
        .admin-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--dark-card); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #333; }
        .stat-card span { display: block; font-size: 0.8rem; color: #888; }
        .stat-card b { font-size: 1.4rem; color: var(--primary); }

        .user-list { text-align: left; }
        .user-card { background: var(--dark-card); padding: 15px; margin-bottom: 12px; border-radius: 15px; border-left: 4px solid var(--orange); }
        .user-actions { display: flex; gap: 5px; margin-top: 10px; }
        .btn-small { flex: 1; padding: 8px; font-size: 0.8rem; border-radius: 5px; border: none; font-weight: 600; cursor: pointer; }

        .lb-btn { position: absolute; top: 20px; right: 20px; background: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; z-index: 50; cursor: pointer; }
        .shaking { animation: shake 0.15s; }
        @keyframes shake { 0%, 100% { transform: translate(0); } 25% { transform: translate(4px); } 50% { transform: translate(-4px); } 75% { transform: translate(4px); } }
    </style>
</head>
<body>

    <div id="admin-trigger" onclick="openAdminPass()"></div>
    
    <button class="lb-btn" onclick="openLB()">üèÜ</button>

    <div id="login-modal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--primary)">‡∏Å‡∏î ‡∏ú‡∏•‡πÑ‡∏°‡πâ</h2>
            <p>‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
            <input type="text" id="username-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." maxlength="12">
            <button class="btn-action" onclick="saveUser()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
        </div>
    </div>

    <div id="admin-pass-modal" class="modal">
        <div class="modal-content">
            <h2>ADMIN ACCESS</h2>
            <input type="password" id="admin-pass-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô 4 ‡∏´‡∏•‡∏±‡∏Å">
            <button class="btn-action" onclick="verifyAdmin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <button class="btn-action" style="background:#333" onclick="closeModals()">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <div id="admin-panel" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--primary)">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h2>
            <div class="admin-stats">
                <div class="stat-card"><span id="total-users">0</span><b>‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</b></div>
                <div class="stat-card"><span id="total-clicks">0</span><b>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</b></div>
            </div>
            <div class="user-list" id="admin-user-list"></div>
            <button class="btn-action" style="background:#444" onclick="closeModals()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
        </div>
    </div>

    <div id="lb-modal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--primary)">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Real-time</h2>
            <div id="lb-list" style="margin:20px 0; text-align:left;"></div>
            <button class="btn-action" style="background:#444" onclick="closeModals()">‡∏Å‡∏•‡∏±‡∏ö</button>
            <button class="btn-action" style="background:var(--danger); font-size:0.9rem;" onclick="deleteMyAccount()">‚ùå ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
        </div>
    </div>

    <div id="app">
        <div class="score-box">
            <div id="user-label">PLAYER</div>
            <h1 id="score">0</h1>
        </div>
        <div class="click-zone" id="click-area">
            <img id="cat-img" class="cat-img" src="https://img2.pic.in.th/1291.jpg">
        </div>
    </div>

    <script>
        // --- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyAeI9eov6aF8Po2iJpJKq-QeciQcxSEZJo",
            authDomain: "pleiu9.firebaseapp.com",
            databaseURL: "https://pleiu9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pleiu9",
            storageBucket: "pleiu9.firebasestorage.app",
            messagingSenderId: "314793236641",
            appId: "1:314793236641:web:a17bd21dd658a1b4d178e0",
            measurementId: "G-JC0B1JK8ST"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const imgClosed = "https://img2.pic.in.th/1291.jpg";
        const imgOpen = "https://img5.pic.in.th/file/secure-sv1/1289dfbdbaa8381c0358.jpg";
        const audio = new Audio("https://www.myinstants.com/media/sounds/pop-cat-original-meme_3_1.mp3");

        let score = parseInt(localStorage.getItem('pop_score_v4')) || 0;
        let username = localStorage.getItem('pop_user_v4') || "";
        let userId = localStorage.getItem('pop_uuid_v4') || 'u_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('pop_uuid_v4', userId);

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
        window.onload = () => {
            if(!username) document.getElementById('login-modal').style.display = 'flex';
            else { setupUI(); syncScore(); }
            // Pre-load image
            new Image().src = imgOpen;
        };

        function saveUser() {
            const val = document.getElementById('username-input').value.trim();
            if (val) {
                username = val;
                localStorage.setItem('pop_user_v4', username);
                document.getElementById('login-modal').style.display = 'none';
                setupUI();
                syncScore();
            }
        }

        function setupUI() {
            document.getElementById('user-label').innerText = username;
            document.getElementById('score').innerText = score.toLocaleString();
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏° ---
        function handleStart(e) {
            if(e.cancelable) e.preventDefault();
            if(!username) return;
            document.getElementById('cat-img').src = imgOpen;
            document.getElementById('cat-img').classList.add('popped');
            score++;
            document.getElementById('score').innerText = score.toLocaleString();
            localStorage.setItem('pop_score_v4', score);
            
            // Animation & Sound
            document.getElementById('app').classList.remove('shaking');
            void document.getElementById('app').offsetWidth;
            document.getElementById('app').classList.add('shaking');
            audio.currentTime = 0; audio.play().catch(()=>{});
            
            syncScore();
        }

        function handleEnd() {
            document.getElementById('cat-img').src = imgClosed;
            document.getElementById('cat-img').classList.remove('popped');
        }

        function syncScore() {
            if (username) db.ref('leaderboard/' + userId).set({ name: username, score: score });
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö Leaderboard Real-time ---
        function openLB() {
            const lbDiv = document.getElementById('lb-list');
            document.getElementById('lb-modal').style.display = 'flex';
            
            // ‡πÉ‡∏ä‡πâ .on('value') ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏î‡πÜ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
            db.ref('leaderboard').orderByChild('score').limitToLast(10).on('value', (snapshot) => {
                let items = [];
                snapshot.forEach(child => {
                    items.push({ id: child.key, ...child.val() });
                });
                items.sort((a,b) => b.score - a.score);

                lbDiv.innerHTML = items.map((it, idx) => `
                    <div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #222; background:${it.id === userId ? '#332b00' : 'transparent'}">
                        <span>${idx+1}. ${it.name} ${it.id === userId ? '(‡∏Ñ‡∏∏‡∏ì)' : ''}</span>
                        <b style="color:var(--primary)">${it.score.toLocaleString()}</b>
                    </div>`).join('');
            });
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö ADMIN ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ---
        function openAdminPass() { document.getElementById('admin-pass-modal').style.display = 'flex'; }
        
        function verifyAdmin() {
            if (document.getElementById('admin-pass-input').value === "7878") {
                document.getElementById('admin-pass-modal').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'flex';
                loadAdminDashboard();
            } else { alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!"); }
        }

        function loadAdminDashboard() {
            const listDiv = document.getElementById('admin-user-list');
            db.ref('leaderboard').on('value', (s) => {
                let html = '';
                let totalC = 0, userCount = 0;
                s.forEach(c => {
                    const u = c.val(); const uid = c.key;
                    totalC += u.score; userCount++;
                    html += `
                        <div class="user-card">
                            <b>${u.name}</b> <br> <small style="color:#666">${uid}</small>
                            <div style="color:var(--primary)">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${u.score.toLocaleString()}</div>
                            <div class="user-actions">
                                <button class="btn-small" style="background:var(--success)" onclick="adminEditScore('${uid}', ${u.score})">‡πÅ‡∏Å‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                                <button class="btn-small" style="background:var(--danger); color:white" onclick="adminDeleteUser('${uid}')">‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
                            </div>
                        </div>`;
                });
                document.getElementById('total-users').innerText = userCount;
                document.getElementById('total-clicks').innerText = totalC.toLocaleString();
                listDiv.innerHTML = html;
            });
        }

        function adminEditScore(tid, cur) {
            const n = prompt("‡πÉ‡∏™‡πà‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà:", cur);
            if(n !== null) db.ref('leaderboard/'+tid).update({score: parseInt(n)});
        }

        function adminDeleteUser(tid) {
            if(confirm("‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")) db.ref('leaderboard/'+tid).remove();
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ---
        function deleteMyAccount() {
            if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì?")) {
                db.ref('leaderboard/' + userId).remove().then(() => {
                    localStorage.clear();
                    location.reload();
                });
            }
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(m => {
                if(m.id !== 'login-modal') m.style.display = 'none';
            });
            document.getElementById('admin-pass-input').value = "";
            db.ref('leaderboard').off(); // ‡∏´‡∏¢‡∏∏‡∏î‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î RAM
        }

        // Event Listeners
        const area = document.getElementById('click-area');
        area.addEventListener('touchstart', handleStart);
        area.addEventListener('touchend', handleEnd);
        area.addEventListener('mousedown', handleStart);
        area.addEventListener('mouseup', handleEnd);

    </script>
</body>
</html>
